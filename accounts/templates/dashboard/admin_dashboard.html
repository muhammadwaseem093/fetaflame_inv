{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <h3 class="mb-4">Admin Dashboard</h3>

    <!-- Summary Cards -->
    <div class="row g-4">
        {% include 'dashboard/partials/cards.html' %}
    </div>

    <!-- Attendance Chart -->
    <div class="row my-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Attendance Overview (%)
                </div>
                <div class="card-body">
                    <canvas id="attendanceChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- OGP/IGP Chart -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    OGP / IGP Status
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="height: 330px;">
                    <canvas id="ogpChart" style="max-width: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mt-4">
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    Today's Activity
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-striped align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Activity Type</th>
                                <th>Description</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in recent_logs %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ log.activity_type }}</td>
                                <td>{{ log.description }}</td>
                                <td>{{ log.timestamp }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4">No activities found today.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const present = {{ present_today }};
    const absent = {{ absent_today }};
    const late = {{ late_today }};
    const total = present + absent + late;

    const attendanceChart = new Chart(document.getElementById('attendanceChart'), {
        type: 'bar',
        data: {
            labels: ['Present', 'Absent', 'Late'],
            datasets: [{
                label: 'Today Attendance (%)',
                data: [
                    ((present / total) * 100).toFixed(2),
                    ((absent / total) * 100).toFixed(2),
                    ((late / total) * 100).toFixed(2)
                ],
                backgroundColor: ['#198754', '#dc3545', '#ffc107'],
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: '%'
                    }
                }
            }
        }
    });

    const ogpChart = new Chart(document.getElementById('ogpChart'), {
        type: 'doughnut',
        data: {
            labels: ["Today's OGP", 'Pending IGP', 'Pending OGP'],
            datasets: [{
                data: [{{ todays_ogp }}, {{ pending_igp }}, {{ pending_ogp }}],
                backgroundColor: ['#0d6efd', '#ffc107', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'left' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(2);
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
